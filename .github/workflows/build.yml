name: osc-sdk-rust release build

on:
  workflow_dispatch:
    inputs:
      api_version:
        description: 'Outscale API version'
        required: true

permissions:
  contents: write
  pull-requests: write
  id-token: write

jobs:
  auto-build:
    environment: auto-build
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
      - uses: chainguard-dev/actions/setup-gitsign@main

      - name: Stable Rust with rustfmt
        uses: actions-rs/toolchain@16499b5e05bf2e26879000db0c1d13f7e13fa3af # v1
        with:
          profile: minimal
          toolchain: stable
          components: rustfmt

      - name: Write Outscale API version to use
        run: echo "${{ github.event.inputs.api_version }}" > api_version
      - name: auto-generate release
        run: make release-build

      - name: Get SDK version
        id: get-sdk-version
        run: |
          echo "sdk_version=$(cat ./sdk_version)" >> "$GITHUB_OUTPUT"
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v8.1.0
        with:
          committer: "Outscale Bot <opensource+bot@outscale.com>"
          author: "Outscale Bot <opensource+bot@outscale.com>"
          commit-message: "ðŸ”– release: osc-sdk-rust v${{ env.sdk_version }}"
          body: |
            Automatic build of SDK v${{ env.sdk_version }} version based on Outscale API ${{ env.api_version }}.
          title: "SDK v${{ env.sdk_version }}"
          token: "${{ env.token }}"
        env:
          sdk_version: ${{ steps.get-sdk-version.outputs.sdk_version }}
          api_version: ${{ github.event.inputs.api_version }}
          token: ${{ secrets.GH_TOKEN || secrets.GITHUB_TOKEN }}
